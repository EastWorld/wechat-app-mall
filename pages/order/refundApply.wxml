<view class="refund-container">
  <!-- æˆ‘çš„å”®åè®°å½• -->
  <view class="refund-history" wx:if="{{ refundApplyList && refundApplyList.length > 0 }}">
    <view class="section-title">
      <view class="title-line"></view>
      <text class="title-text">æˆ‘çš„å”®å</text>
    </view>
    <view class="history-list">
      <view class="history-item" wx:for="{{ refundApplyList }}" wx:key="id" data-idx="{{ index }}" bind:tap="refundDetail">
        <view class="history-goods">
          <image class="goods-image" src="{{ item.goodInfo.pic }}_m" mode="aspectFill"></image>
          <view class="goods-info">
            <view class="goods-name">{{ item.goodInfo.goodsName }}</view>
            <view class="goods-meta">
              <text class="goods-num">x{{ item.baseInfo.number }}</text>
              <text class="goods-price">Â¥{{ item.baseInfo.amount }}</text>
            </view>
            <view class="apply-time">ç”³è¯·æ—¶é—´ï¼š{{ item.baseInfo.dateAdd }}</view>
          </view>
        </view>
        <view class="history-status">
          <text class="status-text">{{ item.baseInfo.statusStr }}</text>
          <view class="arrow-icon">â€º</view>
        </view>
      </view>
    </view>
  </view>

  <!-- é€‰æ‹©å•†å“ -->
  <view class="section-card">
    <view class="section-title">
      <view class="title-line"></view>
      <text class="title-text">é€‰æ‹©éœ€è¦å”®åçš„å•†å“</text>
    </view>
    <van-radio-group value="{{ goodsIndex }}">
      <view class="goods-list">
        <view class="goods-item {{ !item.afterSale ? 'disabled' : '' }}" wx:for="{{ goods }}" wx:key="id" data-name="{{ index }}" bind:tap="goodsClick">
          <view class="goods-content">
            <view class="goods-name-text">{{ item.goodsName }}</view>
            <view class="not-support" wx:if="{{ !item.afterSale }}">è¯¥å•†å“ä¸æ”¯æŒå”®å</view>
          </view>
          <van-radio name="{{ index }}" disabled="{{ !item.afterSale }}" checked-color="#E4393C" />
        </view>
      </view>
    </van-radio-group>
  </view>

  <!-- å•†å“é¢„è§ˆ -->
  <view class="section-card" wx:if="{{ curGoods }}">
    <view class="section-title">
      <view class="title-line"></view>
      <text class="title-text">å•†å“ä¿¡æ¯</text>
    </view>
    <view class="goods-preview">
      <image class="preview-image" src="{{ curGoods.pic }}_m" mode="aspectFill"></image>
      <view class="preview-info">
        <view class="preview-name">{{ curGoods.goodsName }}</view>
        <view class="preview-price">Â¥{{ curGoods.amount }}</view>
      </view>
    </view>
    <view class="quantity-selector">
      <text class="selector-label">é€€è´§æ•°é‡</text>
      <van-stepper value="{{ number }}" integer min="1" max="{{ curGoods.number }}" bind:change="numberChange" button-size="36rpx" input-width="80rpx" />
    </view>
  </view>

  <!-- å”®åç±»å‹ -->
  <view class="section-card" wx:if="{{ curGoods }}">
    <view class="section-title">
      <view class="title-line"></view>
      <text class="title-text">å”®åç±»å‹</text>
    </view>
    <van-radio-group value="{{ type }}" bind:change="typeChange">
      <view class="option-list">
        <block wx:for="{{typeItems}}" wx:key="*this">
          <view class="option-item" wx:if="{{ curGoods['afterSale' + index] }}" data-name="{{ item.value }}" bind:tap="typeClick">
            <text class="option-text">{{ item.name }}</text>
            <van-radio name="{{ item.value }}" checked-color="#E4393C" />
          </view>
        </block>
      </view>
    </van-radio-group>
  </view>

  <!-- è´§ç‰©çŠ¶æ€ -->
  <view class="section-card" wx:if="{{ curGoods && type == 0 }}">
    <view class="section-title">
      <view class="title-line"></view>
      <text class="title-text">è´§ç‰©çŠ¶æ€</text>
    </view>
    <van-radio-group value="{{ logisticsStatus }}" bind:change="logisticsStatusChange">
      <view class="option-list">
        <view class="option-item" wx:for="{{logisticsStatusItems}}" wx:key="value" data-name="{{ item.value }}" bind:tap="logisticsStatusClick">
          <text class="option-text">{{ item.name }}</text>
          <van-radio name="{{ item.value }}" checked-color="#E4393C" />
        </view>
      </view>
    </van-radio-group>
  </view>

  <!-- å”®ååŸå›  -->
  <view class="section-card" wx:if="{{ curGoods }}">
    <view class="section-title">
      <view class="title-line"></view>
      <text class="title-text">å”®ååŸå› </text>
    </view>
    <van-radio-group value="{{ reason }}" bind:change="reasonChange">
      <view class="reason-list">
        <view class="reason-item" wx:for="{{reasons}}" wx:key="value" data-name="{{ item }}" bind:tap="reasonClick">
          <text class="reason-text">{{ item }}</text>
          <van-radio name="{{ item }}" checked-color="#E4393C" />
        </view>
      </view>
    </van-radio-group>
  </view>

  <!-- å”®åè¯´æ˜ -->
  <view class="section-card" wx:if="{{ curGoods }}">
    <view class="section-title">
      <view class="title-line"></view>
      <text class="title-text">å”®åè¯´æ˜</text>
      <text class="title-tip">ï¼ˆé€‰å¡«ï¼‰</text>
    </view>
    <view class="remark-box">
      <textarea class="remark-input" model:value="{{ remark }}" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„é—®é¢˜ï¼Œæœ‰åŠ©äºæˆ‘ä»¬æ›´å¿«å¤„ç†" placeholder-class="remark-placeholder" maxlength="500" auto-height></textarea>
    </view>
  </view>

  <!-- ä¸Šä¼ å›¾ç‰‡ -->
  <view class="section-card" wx:if="{{ curGoods }}">
    <view class="section-title">
      <view class="title-line"></view>
      <text class="title-text">ä¸Šä¼ å‡­è¯</text>
      <text class="title-tip">ï¼ˆé€‰å¡«ï¼Œæœ€å¤š9å¼ ï¼‰</text>
    </view>
    <view class="upload-box">
      <van-uploader
        accept="image"
        multiple
        max-count="9"
        upload-text="ä¸Šä¼ å›¾ç‰‡"
        image-fit="aspectFill"
        file-list="{{ picsList }}"
        bind:after-read="afterPicRead"
        bind:delete="afterPicDel"
      />
    </view>
  </view>

  <!-- æäº¤æŒ‰é’® -->
  <view class="submit-box" wx:if="{{ curGoods }}">
    <button class="submit-btn" bind:tap="bindSave">æäº¤ç”³è¯·</button>
  </view>

  <!-- åº•éƒ¨å®‰å…¨åŒº -->
  <view class="safe-area"></view>
</view>

<!-- å”®åè¯¦æƒ…å¼¹çª— -->
<van-popup show="{{ popShow }}" position="bottom" round custom-style="max-height: 85vh; background: #F5F5F5;" bind:close="popClose">
  <view class="popup-container">
    <!-- æ ‡é¢˜æ  -->
    <view class="popup-header">
      <text class="popup-title">å”®åè¯¦æƒ…</text>
      <view class="popup-close" bind:tap="popClose">âœ•</view>
    </view>

    <!-- å•†å“ä¿¡æ¯ -->
    <view class="popup-goods">
      <image class="popup-goods-image" src="{{ curRufund.goodInfo.pic }}_m" mode="aspectFill"></image>
      <view class="popup-goods-info">
        <view class="popup-goods-name">{{ curRufund.goodInfo.goodsName }}</view>
        <view class="popup-goods-meta">
          <text class="popup-goods-num">x{{ curRufund.baseInfo.number }}</text>
          <text class="popup-goods-price">Â¥{{ curRufund.baseInfo.amount }}</text>
        </view>
      </view>
    </view>

    <!-- çŠ¶æ€æç¤º -->
    <view class="popup-notice {{ curRufund.baseInfo.status == 4 ? 'success' : curRufund.baseInfo.status == 2 ? 'error' : 'info' }}">
      <view class="notice-icon">
        <text wx:if="{{curRufund.baseInfo.status == 0}}">â±</text>
        <text wx:if="{{curRufund.baseInfo.status == 2}}">âœ•</text>
        <text wx:if="{{curRufund.baseInfo.status == 3}}">âš™</text>
        <text wx:if="{{curRufund.baseInfo.status == 4}}">âœ“</text>
      </view>
      <text class="notice-text" wx:if="{{curRufund.baseInfo.status == 0}}">å·²ç”³è¯·ï¼Œç­‰å¾…å•†å®¶å¤„ç†ï¼Œè¯·è€å¿ƒç­‰å¾…</text>
      <text class="notice-text" wx:if="{{curRufund.baseInfo.status == 2}}">å•†å®¶å·²æ‹’ç»ï¼Œå¦‚è¯‰æ±‚æœªè§£å†³è¯·è”ç³»å®¢æœ</text>
      <text class="notice-text" wx:if="{{curRufund.baseInfo.status == 3}}">å•†å®¶æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…</text>
      <text class="notice-text" wx:if="{{curRufund.baseInfo.status == 4}}">æœ¬æ¬¡å”®åå·²å¤„ç†å®Œæˆ</text>
    </view>
    <!-- å¯„å›åœ°å€ä¿¡æ¯ -->
    <view wx:if="{{ curRufund.baseInfo.status2 > 0 }}" class="back-address-card">
      <view class="address-header">
        <view class="header-icon">ğŸ“¦</view>
        <text class="header-title">å•†å“å¯„å›åœ°å€</text>
      </view>
      <view class="address-content">
        <view class="address-row">
          <text class="address-label">æ”¶è´§äººï¼š</text>
          <text class="address-text">{{ logisticsContent.linkMan }}</text>
        </view>
        <view class="address-row">
          <text class="address-label">è”ç³»ç”µè¯ï¼š</text>
          <text class="address-text">{{ logisticsContent.mobile }}</text>
        </view>
        <view class="address-row">
          <text class="address-label">æ”¶è´§åœ°å€ï¼š</text>
          <text class="address-text">{{ logisticsContent.address }}</text>
        </view>
      </view>
      
      <!-- å¾…å¡«å†™å¿«é€’å•å· -->
      <view wx:if="{{ curRufund.baseInfo.status2 == 1 }}" class="logistics-action">
        <button class="fill-logistics-btn" bind:tap="showLogisticsDialog">å¡«å†™å¯„å›å¿«é€’å•å·</button>
      </view>
      
      <!-- å·²å¡«å†™å¿«é€’ä¿¡æ¯ -->
      <view wx:if="{{ curRufund.baseInfo.status2 == 2 }}" class="logistics-filled">
        <view class="filled-header">
          <view class="filled-icon">âœ“</view>
          <text class="filled-title">å·²å¡«å†™å¿«é€’ä¿¡æ¯</text>
        </view>
        <view class="filled-content">
          <view class="filled-row">
            <text class="filled-label">å¿«é€’å…¬å¸ï¼š</text>
            <text class="filled-value">{{ logisticsContent.shipperName }}</text>
          </view>
          <view class="filled-row">
            <text class="filled-label">å¿«é€’å•å·ï¼š</text>
            <text class="filled-value">{{ logisticsContent.trackingNumber }}</text>
          </view>
        </view>
      </view>
    </view>
    <!-- è¯¦ç»†ä¿¡æ¯ -->
    <view class="popup-details">
      <view class="detail-item">
        <text class="detail-label">ç”³è¯·æ—¶é—´</text>
        <text class="detail-value">{{ curRufund.baseInfo.dateAdd }}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">å”®åç±»å‹</text>
        <text class="detail-value">{{ curRufund.baseInfo.typeStr }}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">ç‰©æµçŠ¶æ€</text>
        <text class="detail-value">{{ curRufund.baseInfo.logisticsStatusStr }}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">å”®ååŸå› </text>
        <text class="detail-value">{{ curRufund.baseInfo.reason }}</text>
      </view>
      <view class="detail-item" wx:if="{{ curRufund.baseInfo.remark }}">
        <text class="detail-label">å¤‡æ³¨è¯´æ˜</text>
        <text class="detail-value remark">{{ curRufund.baseInfo.remark }}</text>
      </view>
    </view>

    <!-- ä¸¾è¯ç…§ç‰‡ -->
    <view class="popup-photos" wx:if="{{ curRufund.pics && curRufund.pics.length > 0 }}">
      <view class="photos-title">ä¸¾è¯ç…§ç‰‡</view>
      <view class="photos-grid">
        <image
          wx:for="{{ curRufund.pics }}" wx:key="*this"
          class="photo-item" mode="aspectFill"
          src="{{ item.pic }}_m"
          data-current="{{ item.pic }}_m"
          bind:tap="previewImageimageList"
        ></image>
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œ -->
    <view class="popup-actions">
      <view wx:if="{{ customerServiceType == 'QW' }}" class="action-service" bind:tap="customerService">
        <text class="service-icon">ğŸ’¬</text>
        <text class="service-text">è”ç³»å®¢æœ</text>
      </view>
      <view wx:else style="margin-bottom: 32rpx;">
        <button class="action-btn" open-type="contact" style="background: #F8F8F8;color: #333;">è”ç³»å®¢æœ</button>
      </view>
      <view class="action-btn-box">
        <button class="action-btn cancel" wx:if="{{curRufund.baseInfo.status == 0}}" bind:tap="refundApplyCancel">æ’¤å›ç”³è¯·</button>
        <button class="action-btn disabled" wx:if="{{curRufund.baseInfo.status == 1}}" disabled>æ‚¨å·²æ’¤é”€æœ¬æ¬¡ç”³è¯·</button>
        <button class="action-btn disabled" wx:if="{{curRufund.baseInfo.status == 2}}" disabled>å•†å®¶å·²å–æ¶ˆæœ¬æ¬¡ç”³è¯·</button>
        <button class="action-btn disabled" wx:if="{{curRufund.baseInfo.status == 3}}" disabled>å•†å®¶æ­£åœ¨å¤„ç†ä¸­</button>
        <button class="action-btn disabled success" wx:if="{{curRufund.baseInfo.status == 4}}" disabled>æœ¬æ¬¡å”®åå·²å¤„ç†å®Œç»“</button>
      </view>
    </view>
  </view>
</van-popup>

<!-- å¿«é€’ä¿¡æ¯è¾“å…¥å¼¹çª— -->
<van-popup show="{{ logisticsDialogShow }}" position="center" round custom-style="width: 85%; max-width: 600rpx;" bind:close="closeLogisticsDialog">
  <view class="logistics-dialog">
    <view class="dialog-header">
      <text class="dialog-title">å¡«å†™å¿«é€’ä¿¡æ¯</text>
      <view class="dialog-close" bind:tap="closeLogisticsDialog">âœ•</view>
    </view>
    
    <view class="dialog-content">
      <view class="dialog-tip">
        <text class="tip-icon">ğŸ’¡</text>
        <text class="tip-text">è¯·å¡«å†™æ‚¨å¯„å›å•†å“çš„å¿«é€’ä¿¡æ¯</text>
      </view>
      
      <view class="input-group">
        <view class="input-label">å¿«é€’å…¬å¸</view>
        <input 
          class="input-field" 
          placeholder="è¯·è¾“å…¥å¿«é€’å…¬å¸åç§°" 
          placeholder-class="input-placeholder"
          model:value="{{ shipperName }}"
        />
      </view>
      
      <view class="input-group">
        <view class="input-label">å¿«é€’å•å·</view>
        <input 
          class="input-field" 
          placeholder="è¯·è¾“å…¥å¿«é€’å•å·" 
          placeholder-class="input-placeholder"
          model:value="{{ trackingNumber }}"
        />
      </view>
    </view>
    
    <view class="dialog-actions">
      <button class="dialog-btn cancel-btn" bind:tap="closeLogisticsDialog">å–æ¶ˆ</button>
      <button class="dialog-btn confirm-btn" bind:tap="submitLogistics">ç¡®è®¤æäº¤</button>
    </view>
  </view>
</van-popup>